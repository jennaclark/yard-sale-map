<!DOCTYPE html>
<html>
<head>
  <title>Neighborhood Yard Sale Map</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    #map {
      height: 500px;
      width: 100%;
      border-radius: 8px;
      margin-top: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    #category-filters {
      margin: 16px 0;
      padding: 12px;
      background: #f8f8f8;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .filter-title {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 16px;
      color: #555;
    }
    .category-btn {
      margin: 5px;
      padding: 8px 12px;
      background: #eee;
      border: 1px solid #ddd;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    .category-btn:hover {
      background: #e0e0e0;
    }
    .category-btn.active {
      background: #4285f4;
      color: white;
      border-color: #4285f4;
    }
    .info-window {
      max-width: 300px;
    }
    .info-window h3 {
      margin-top: 0;
      color: #4285f4;
    }
    .footer {
      margin-top: 20px;
      font-size: 12px;
      color: #666;
      text-align: center;
    }
    .loading {
      text-align: center;
      padding: 20px;
      font-style: italic;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>Neighborhood Yard Sale Map</h1>
  <p>Browse yard sales in your area and filter by what you're looking for!</p>
  
  <div id="category-filters">
    <h3 class="filter-title">Filter by items for sale:</h3>
    <button class="category-btn active" data-category="all">Show All</button>
    <!-- Category buttons will be added here dynamically -->
    <div style="margin-top: 12px; font-size: 13px; color: #666;">
      Click on markers to see more details about each yard sale.
    </div>
  </div>
  
  <div id="map-container">
    <div id="loading" class="loading">Loading yard sales...</div>
    <div id="map"></div>
  </div>
  
  <div class="footer">
    <p>Made with Google Maps. Data from Community Yard Sale signup form.</p>
  </div>

  <script>
    const API_KEY = 'AIzaSyBuIJWoU-H_mxlaUJLhWHrGz_byuNu_1XA';
    
    // Google Sheet ID
    const SHEET_ID = '13fY7TuhWJvMlibnnHW9Qw6MlXAMtRba3aGq7TpDUvpQ';
    const SHEET_GID = '1879054771';
    
    // Global variables
    let map;
    let markers = [];
    let allCategories = new Set();
    let locations = [];
    
    // Column names from your form (adjust these based on your actual form)
    const COLUMN_NAME = 'Name';
    const COLUMN_ADDRESS = 'Address';
    const COLUMN_ITEMS = 'Items for sale';
    const COLUMN_DESCRIPTION = 'Description';
    const COLUMN_EMAIL = 'Email'; // We won't display this publicly
    
    // Load the Google Maps script
    function loadGoogleMapsScript() {
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=initMap`;
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
    }
    
    // Initialize the map
    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 37.7749, lng: -122.4194}, // Default center (San Francisco)
        zoom: 12,
        mapTypeControl: true,
        streetViewControl: true,
        fullscreenControl: true
      });
      
      // Load data from Google Sheets
      loadSheetData();
    }
    
    // Load data from Google Sheets
    function loadSheetData() {
      // URL for published Google Sheet as CSV
      const sheetUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;
      
      fetch(sheetUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Failed to load spreadsheet: ${response.status}`);
          }
          return response.text();
        })
        .then(csv => {
          const data = parseCSV(csv);
          processData(data);
        })
        .catch(error => {
          console.error('Error loading spreadsheet data:', error);
          document.getElementById('loading').innerHTML = 
            'Could not load yard sale data. Please check the spreadsheet sharing settings or try again later.';
          // Use sample data for testing
          useSampleData();
        });
    }
    
    // Parse CSV data
    function parseCSV(csv) {
      const lines = csv.split('\n');
      const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
      
      return lines.slice(1).filter(line => line.trim() !== '').map(line => {
        // Handle commas inside quoted fields
        const values = [];
        let inQuote = false;
        let currentValue = '';
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          
          if (char === '"') {
            inQuote = !inQuote;
          } else if (char === ',' && !inQuote) {
            values.push(currentValue);
            currentValue = '';
          } else {
            currentValue += char;
          }
        }
        
        values.push(currentValue); // Add the last value
        
        const entry = {};
        headers.forEach((header, index) => {
          let value = values[index] || '';
          value = value.replace(/"/g, '').trim();
          entry[header] = value;
        });
        
        return entry;
      });
    }
    
    // Use sample data for testing if the real data can't be loaded
    function useSampleData() {
      const sampleData = [
        {
          [COLUMN_NAME]: "Jane Smith",
          [COLUMN_ADDRESS]: "123 Main St, San Francisco, CA",
          [COLUMN_ITEMS]: "Furniture, Books, Toys",
          [COLUMN_DESCRIPTION]: "Multi-family yard sale with lots of kids items and furniture.",
          [COLUMN_EMAIL]: "jane@example.com"
        },
        {
          [COLUMN_NAME]: "John Doe",
          [COLUMN_ADDRESS]: "456 Oak Ave, San Francisco, CA",
          [COLUMN_ITEMS]: "Electronics, Tools, Sporting Goods",
          [COLUMN_DESCRIPTION]: "Moving sale! Everything must go. Tools, electronics, and sporting equipment.",
          [COLUMN_EMAIL]: "john@example.com"
        },
        {
          [COLUMN_NAME]: "Alice Johnson",
          [COLUMN_ADDRESS]: "789 Pine St, San Francisco, CA",
          [COLUMN_ITEMS]: "Clothing, Toys, Home Decor",
          [COLUMN_DESCRIPTION]: "Seasonal cleanout! Children's clothes, toys, and home decorations.",
          [COLUMN_EMAIL]: "alice@example.com"
        }
      ];
      
      processData(sampleData);
    }
    
    // Process data and add markers
    function processData(data) {
      // Remove the loading message
      document.getElementById('loading').style.display = 'none';
      
      // Store the data
      locations = data.filter(entry => entry[COLUMN_ADDRESS] && entry[COLUMN_ADDRESS].trim() !== '');
      
      if (locations.length === 0) {
        document.getElementById('loading').innerHTML = 'No yard sale locations found.';
        document.getElementById('loading').style.display = 'block';
        return;
      }
      
      // Process categories first
      locations.forEach(location => {
        // Extract categories from the items for sale
        if (location[COLUMN_ITEMS]) {
          const categories = location[COLUMN_ITEMS].split(',')
            .map(cat => cat.trim())
            .filter(cat => cat !== '');
          
          location.categories = categories;
          
          // Add to set of all categories
          categories.forEach(category => {
            allCategories.add(category);
          });
        } else {
          location.categories = [];
        }
      });
      
      // Create category filters
      createCategoryFilters();
      
      // Geocode addresses and add markers
      locations.forEach((location, index) => {
        geocodeAddress(location, index);
      });
    }
    
    // Create category filter buttons
    function createCategoryFilters() {
      const filterContainer = document.getElementById('category-filters');
      
      // Sort categories alphabetically
      Array.from(allCategories).sort().forEach(category => {
        const button = document.createElement('button');
        button.className = 'category-btn';
        button.setAttribute('data-category', category);
        button.textContent = category;
        button.addEventListener('click', (e) => {
          filterMarkers(e.target, category);
        });
        
        filterContainer.appendChild(button);
      });
      
      // Add event listener to "Show All" button
      document.querySelector('[data-category="all"]').addEventListener('click', (e) => {
        filterMarkers(e.target, 'all');
      });
    }
    
    // Geocode an address
    function geocodeAddress(location, index) {
      const geocoder = new google.maps.Geocoder();
      
      geocoder.geocode({ address: location[COLUMN_ADDRESS] }, (results, status) => {
        if (status === 'OK' && results[0]) {
          const position = results[0].geometry.location;
          
          // Add the geocoded location to our data
          location.lat = position.lat();
          location.lng = position.lng();
          
          // Add a marker
          addMarker(location, index);
        } else {
          console.error(`Geocoding failed for address: ${location[COLUMN_ADDRESS]}`);
        }
      });
    }
    
    // Add a marker for a location
    function addMarker(location, index) {
      const marker = new google.maps.Marker({
        position: { lat: location.lat, lng: location.lng },
        map: map,
        title: location[COLUMN_NAME],
        animation: google.maps.Animation.DROP
      });
      
      // Format categories for display
      const categoriesHtml = location.categories.length > 0 
        ? `<p><strong>Items for sale:</strong> ${location.categories.join(', ')}</p>`
        : '';
      
      // Create info window content
      const contentString = `
        <div class="info-window">
          <h3>${location[COLUMN_NAME]}</h3>
          <p><strong>Address:</strong> ${location[COLUMN_ADDRESS]}</p>
          ${categoriesHtml}
          <p>${location[COLUMN_DESCRIPTION] || ''}</p>
        </div>
      `;
      
      const infoWindow = new google.maps.InfoWindow({
        content: contentString
      });
      
      marker.addListener('click', () => {
        infoWindow.open(map, marker);
      });
      
      // Store category data with the marker
      marker.categories = location.categories;
      
      // Add to our markers array
      markers.push(marker);
      
      // Adjust map to fit all markers
      if (markers.length === locations.length) {
        fitMapToBounds();
      }
    }
    
    // Filter markers by category
    function filterMarkers(clickedButton, category) {
      // Update button states
      const buttons = document.querySelectorAll('.category-btn');
      buttons.forEach(btn => btn.classList.remove('active'));
      clickedButton.classList.add('active');
      
      // Filter markers
      markers.forEach(marker => {
        if (category === 'all') {
          marker.setVisible(true);
        } else {
          marker.setVisible(marker.categories.includes(category));
        }
      });
      
      // Adjust map to fit visible markers
      fitMapToBounds();
    }
    
    // Fit map to bounds of all markers
    function fitMapToBounds() {
      if (markers.length === 0) return;
      
      const bounds = new google.maps.LatLngBounds();
      let visibleMarkers = 0;
      
      markers.forEach(marker => {
        if (marker.getVisible()) {
          bounds.extend(marker.getPosition());
          visibleMarkers++;
        }
      });
      
      if (visibleMarkers > 0) {
        map.fitBounds(bounds);
        
        // Adjust zoom if there's only one marker
        if (visibleMarkers === 1) {
          google.maps.event.addListenerOnce(map, 'bounds_changed', () => {
            map.setZoom(15);
          });
        }
      }
    }
    
    // Load the Google Maps script when the page loads
    window.onload = loadGoogleMapsScript;
  </script>
</body>
</html>
